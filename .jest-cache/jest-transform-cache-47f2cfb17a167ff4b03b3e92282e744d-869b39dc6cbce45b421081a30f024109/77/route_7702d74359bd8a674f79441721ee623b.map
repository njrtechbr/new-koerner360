{"version":3,"names":["POST","request","params","cov_1dw9wtg4cu","f","s","session","_nextauth","getServerSession","_auth","authOptions","user","b","_server","NextResponse","json","erro","status","userType","_atendentes","MENSAGENS_ERRO_ATENDENTES","SEM_PERMISSAO","atendenteId","idAtendenteSchema","parse","id","atendente","_prisma","prisma","findUnique","where","include","usuario","select","nome","email","ativo","ATENDENTE_NAO_ENCONTRADO","dadosRequisicao","motivo","novoStatus","ativarAtendenteSchema","dadosAnteriores","statusAtendente","usuarioAtivo","resultado","$transaction","tx","usuarioAtualizado","update","usuarioId","data","atendenteAtualizado","historicoAlteracaoAtendente","create","tipo","descricao","valorAnterior","JSON","stringify","valorNovo","criadoPorId","mensagem","ativadoEm","Date","toISOString","ativadoPor","name","error","console","_zod","ZodError","DADOS_INVALIDOS","detalhes","errors","ERRO_INTERNO"],"sources":["C:\\Users\\Nereu Jr\\Documents\\Dev\\new\\src\\app\\api\\atendentes\\[id]\\ativar\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { getServerSession } from 'next-auth';\nimport { authOptions } from '@/lib/auth';\nimport { prisma } from '@/lib/prisma';\nimport { z } from 'zod';\nimport {\n  idAtendenteSchema,\n  ativarAtendenteSchema,\n  MENSAGENS_ERRO_ATENDENTES,\n} from '@/lib/validations/atendentes';\nimport { ZodError } from 'zod';\n\ninterface RouteParams {\n  params: {\n    id: string;\n  };\n}\n\n/**\n * POST /api/atendentes/[id]/ativar\n * Ativa um atendente inativo\n */\nexport async function POST(request: NextRequest, { params }: RouteParams) {\n  try {\n    // Verificar autenticação\n    const session = await getServerSession(authOptions);\n    if (!session?.user) {\n      return NextResponse.json({ erro: 'Não autorizado' }, { status: 401 });\n    }\n\n    // Verificar permissões (apenas ADMIN pode ativar atendentes)\n    if (session.user.userType !== 'ADMIN') {\n      return NextResponse.json(\n        { erro: MENSAGENS_ERRO_ATENDENTES.SEM_PERMISSAO },\n        { status: 403 }\n      );\n    }\n\n    // Validar ID\n    const atendenteId = idAtendenteSchema.parse(params.id);\n\n    // Buscar atendente com dados do usuário\n    const atendente = await prisma.atendente.findUnique({\n      where: { id: atendenteId },\n      include: {\n        usuario: {\n          select: {\n            id: true,\n            nome: true,\n            email: true,\n            ativo: true,\n          },\n        },\n      },\n    });\n\n    if (!atendente) {\n      return NextResponse.json(\n        { erro: MENSAGENS_ERRO_ATENDENTES.ATENDENTE_NAO_ENCONTRADO },\n        { status: 404 }\n      );\n    }\n\n    // Verificar se o atendente já está ativo\n    if (atendente.status === 'ATIVO' && atendente.usuario.ativo) {\n      return NextResponse.json(\n        { erro: 'Atendente já está ativo' },\n        { status: 400 }\n      );\n    }\n\n    // Extrair dados do corpo da requisição\n    const dadosRequisicao = await request.json();\n\n    // Validar dados\n    const { motivo, novoStatus } = ativarAtendenteSchema.parse(dadosRequisicao);\n\n    // Salvar dados anteriores para o histórico\n    const dadosAnteriores = {\n      statusAtendente: atendente.status,\n      usuarioAtivo: atendente.usuario.ativo,\n    };\n\n    // Usar transação para garantir consistência\n    const resultado = await prisma.$transaction(async tx => {\n      // Ativar usuário\n      const usuarioAtualizado = await tx.usuario.update({\n        where: { id: atendente.usuarioId },\n        data: { ativo: true },\n      });\n\n      // Atualizar status do atendente\n      const atendenteAtualizado = await tx.atendente.update({\n        where: { id: atendenteId },\n        data: { status: novoStatus },\n      });\n\n      // Registrar no histórico de alterações\n      await tx.historicoAlteracaoAtendente.create({\n        data: {\n          atendenteId,\n          tipo: 'ATIVACAO',\n          descricao: `Atendente reativado - ${motivo}`,\n          valorAnterior: JSON.stringify(dadosAnteriores),\n          valorNovo: JSON.stringify({\n            statusAtendente: novoStatus,\n            usuarioAtivo: true,\n            motivo,\n          }),\n          criadoPorId: session.user.id,\n        },\n      });\n\n      return {\n        atendente: atendenteAtualizado,\n        usuario: usuarioAtualizado,\n      };\n    });\n\n    return NextResponse.json({\n      mensagem: 'Atendente ativado com sucesso',\n      atendente: {\n        id: resultado.atendente.id,\n        status: resultado.atendente.status,\n        usuario: {\n          id: resultado.usuario.id,\n          nome: resultado.usuario.nome,\n          email: resultado.usuario.email,\n          ativo: resultado.usuario.ativo,\n        },\n        ativadoEm: new Date().toISOString(),\n        ativadoPor: {\n          id: session.user.id,\n          nome: session.user.name,\n        },\n        motivo,\n      },\n    });\n  } catch (error) {\n    console.error('Erro ao ativar atendente:', error);\n\n    if (error instanceof ZodError) {\n      return NextResponse.json(\n        {\n          erro: MENSAGENS_ERRO_ATENDENTES.DADOS_INVALIDOS,\n          detalhes: error.errors,\n        },\n        { status: 400 }\n      );\n    }\n\n    return NextResponse.json(\n      { erro: MENSAGENS_ERRO_ATENDENTES.ERRO_INTERNO },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":"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","ignoreList":[]}